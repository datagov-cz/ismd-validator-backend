name: Build Docker on Dev

on:
  push:
    branches:
      - dev
    paths-ignore:
      - '**/README.md'
      - '**/.gitignore'
      - '**/*.md'
      - '**/.gitkeep'
      - '**/LICENSE'
      - '**/target/**'
      - '**/.idea/**'
      - '**/*.iml'

permissions:
  contents: read
  packages: write

jobs:
  run-tests:
    uses: ./.github/workflows/reusable-test.yml
    
  check-version-bump:
    runs-on: ubuntu-latest
    outputs:
      skip-build: ${{ steps.check-commit.outputs.skip-build }}
    steps:
      - name: Check for version bump commit
        id: check-commit
        run: |
          if [[ "${{ github.event.head_commit.message }}" =~ (Release v|Bump version) ]]; then
            echo "skip-build=true" >> $GITHUB_OUTPUT
            echo "Skipping build: Version bump detected"
          else
            echo "skip-build=false" >> $GITHUB_OUTPUT
          fi
  
  # Build validator module on every push (except version bump commits)
  build-validator:
    needs: [run-tests, check-version-bump]
    if: needs.check-version-bump.outputs.skip-build != 'true'
    uses: ./.github/workflows/reusable-docker-build.yml
    with:
      branch: dev
      module: validator
